import{a as M}from"./chunk-T52VLWNS.js";import{a as U}from"./chunk-KA5JLKJL.js";import{a as R}from"./chunk-BM7MHGYW.js";import"./chunk-X5YLR3NI.js";import{q as L}from"./chunk-D7OGTJNG.js";import{$ as S,Ab as D,Bb as A,Ca as k,Fa as _,Gb as B,Ha as v,I as E,Ia as I,Ib as F,J as w,Lb as j,Nb as O,Tb as T,Wa as o,Xa as d,Ya as P,aa as l,fb as c,ga as p,hb as u,ka as b,oa as h,wa as m,xa as r,ya as i,za as y}from"./chunk-JXKQ7VXO.js";import{a as C,i as x}from"./chunk-ODN5LVDJ.js";var g=class a{constructor(t,e){this.http=t;this.appointmentService=e}amount;userId;appointmentId;ngOnInit(){return x(this,null,function*(){if(!this.userId){console.error("userId mancante");return}let e=(yield this.http.get("/payments/config").toPromise()).clientId;yield this.loadPaypalScript(e),this.renderButtons()})}loadPaypalScript(t){return new Promise((e,n)=>{if(document.getElementById("paypal-sdk"))return e(!0);let s=document.createElement("script");s.id="paypal-sdk",s.src=`https://www.paypal.com/sdk/js?client-id=${t}&currency=EUR`,s.onload=()=>e(!0),s.onerror=f=>n(f),document.body.appendChild(s)})}renderButtons(){window.paypal.Buttons({style:{layout:"horizontal",color:"gold",shape:"rect",label:"pay"},createOrder:(t,e)=>this.http.post("/payments/create-order",{amount:this.amount,userId:this.userId}).toPromise().then(n=>n.id),onApprove:(t,e)=>x(this,null,function*(){try{let n=yield this.http.post("/payments/capture-order",{orderID:t.orderID,userId:this.userId}).toPromise();console.log("Pagamento completato:",n),alert("\u2705 Pagamento completato con successo!"),this.appointmentId&&this.appointmentService.confirmAppointment(this.appointmentId).subscribe({next:()=>{alert("\u{1F4C5} Appuntamento confermato!")},error:s=>{console.error("Errore durante conferma:",s),alert("Pagamento completato, ma errore nella conferma appuntamento.")}}),e&&typeof e.close=="function"&&e.close()}catch(n){console.error("Errore durante la cattura:",n),alert("Errore nel pagamento PayPal.")}}),onError:t=>{console.error("PayPal error:",t),alert("Errore PayPal. Riprova pi\xF9 tardi.")}}).render("#paypal-button-container")}static \u0275fac=function(e){return new(e||a)(p(j),p(M))};static \u0275cmp=b({type:a,selectors:[["app-cart-paypal"]],inputs:{amount:"amount",userId:"userId",appointmentId:"appointmentId"},decls:1,vars:0,consts:[["id","paypal-button-container",1,"mt-4"]],template:function(e,n){e&1&&k(0,"div",0)},encapsulation:2})};function z(a,t){a&1&&(r(0,"div",15)(1,"h2",16),o(2,"Il carrello \xE8 vuoto"),i(),r(3,"p",17),o(4,"Aggiungi ebook o specialisti per iniziare."),i(),r(5,"div",18)(6,"a",19),o(7," \u{1F4DA} Esplora i nostri Ebook "),i(),r(8,"a",20),o(9," \u{1F469}\u200D\u2695\uFE0F Prenota una seduta "),i()()())}function W(a,t){if(a&1){let e=_();r(0,"div",21)(1,"div",22)(2,"div",23),y(3,"img",24),r(4,"div")(5,"h2",25),o(6),i(),r(7,"p",26),o(8),i(),r(9,"p",27),o(10),c(11,"currency"),i()()(),r(12,"button",28),v("click",function(){let s=E(e).$implicit,f=I();return w(f.removeItem(s.id))}),r(13,"span"),o(14,"\u{1F5D1}\uFE0F"),i(),r(15,"span"),o(16,"Rimuovi"),i()()()()}if(a&2){let e=t.$implicit;l(3),m("src",e.ebooks==null?null:e.ebooks.image_url,S),l(3),d(e.ebooks==null?null:e.ebooks.title),l(2),P("Autore: ",e.ebooks==null?null:e.ebooks.author),l(2),d(u(11,4,e.ebooks==null?null:e.ebooks.price,"EUR"))}}function $(a,t){if(a&1&&y(0,"app-cart-paypal",29),a&2){let e=I();m("amount",e.totalWithVAT)("userId",e.user.id)("appointmentId",void 0)}}var N=class a{constructor(t,e){this.cartService=t;this.auth=e}cartItems=[];user;isLoading=!0;get subtotal(){return this.realCartItems.reduce((t,e)=>t+(e.ebooks?.price||0),0)}get totalWithVAT(){return this.subtotal*1.22}ngOnInit(){console.log(this.subtotal),this.auth.currentAppUser.subscribe(t=>{this.user=t,t?.id?this.loadCart(t.id):(this.cartItems=[],this.isLoading=!1)})}loadCart(t){this.isLoading=!0,this.cartService.getCart(t).subscribe({next:e=>{this.cartItems=e.map(n=>C({},n)),this.isLoading=!1},error:e=>{console.error("Errore caricamento carrello:",e),this.cartItems=[],this.isLoading=!1}})}removeItem(t){this.user?.id&&this.cartService.removeItem(this.user.id,t).subscribe(()=>this.loadCart(this.user.id))}checkout(){alert("Checkout in arrivo \u{1F6D2}")}get realCartItems(){return this.cartItems.filter(t=>t.ebook_id)}get isEmpty(){return this.realCartItems.length===0}static \u0275fac=function(e){return new(e||a)(p(U),p(R))};static \u0275cmp=b({type:a,selectors:[["app-cart"]],decls:33,vars:15,consts:[[1,"max-w-7xl","mx-auto","p-6","grid","grid-cols-1","lg:grid-cols-3","gap-10"],[1,"lg:col-span-2"],[1,"text-4xl","font-extrabold","text-[#5EADB1]","mb-10","tracking-tight"],["class","text-center bg-white/70 backdrop-blur-lg rounded-2xl shadow-lg p-12 border border-gray-200",4,"ngIf"],["class","bg-white/80 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-12 border border-gray-100 hover:shadow-2xl transition-all duration-300",4,"ngFor","ngForOf"],[1,"bg-white/90","backdrop-blur-md","shadow-xl","rounded-2xl","p-6","h-fit","sticky","top-6","border","border-gray-100"],[1,"text-2xl","font-semibold","text-gray-800","mb-6"],[1,"space-y-4","mb-6"],[1,"flex","justify-between","text-gray-600"],[1,"font-medium"],[1,"flex","justify-between","text-gray-800","text-lg","font-semibold","border-t","border-gray-200","pt-4"],[1,"text-[#5EADB1]"],[1,"w-full","py-3","text-lg","bg-[#5EADB1]","text-white","font-semibold","rounded-xl","hover:bg-[#4c9397]","shadow-md","transition-all",3,"click"],[3,"amount","userId","appointmentId",4,"ngIf"],[1,"text-sm","text-gray-500","text-center","mt-4"],[1,"text-center","bg-white/70","backdrop-blur-lg","rounded-2xl","shadow-lg","p-12","border","border-gray-200"],[1,"text-2xl","font-semibold","text-gray-700","mb-4"],[1,"text-gray-500","mb-8"],[1,"flex","flex-col","sm:flex-row","gap-4","justify-center"],["routerLink","/ebooks",1,"px-8","py-3","bg-[#5EADB1]","text-white","font-semibold","rounded-xl","hover:bg-[#4c9397]","transition-all","shadow-md"],["routerLink","/my-appointments",1,"px-8","py-3","bg-[#5EADB1]","text-white","font-semibold","rounded-xl","hover:bg-[#4c9397]","transition-all","shadow-md"],[1,"bg-white/80","backdrop-blur-lg","rounded-2xl","shadow-xl","p-8","mb-12","border","border-gray-100","hover:shadow-2xl","transition-all","duration-300"],[1,"flex","flex-col","md:flex-row","items-start","md:items-center","justify-between","gap-6","mb-8"],[1,"flex","items-center","gap-6"],["alt","Copertina ebook",1,"w-28","h-40","object-cover","rounded-xl","shadow-sm","border","border-gray-200",3,"src"],[1,"text-2xl","font-bold","text-gray-800","mb-1"],[1,"text-gray-500","text-sm"],[1,"text-gray-700","font-semibold","mt-2"],[1,"flex","items-center","gap-2","px-5","py-2","bg-red-500","text-white","font-semibold","rounded-xl","shadow","hover:bg-red-600","transition",3,"click"],[3,"amount","userId","appointmentId"]],template:function(e,n){e&1&&(r(0,"div",0)(1,"div",1)(2,"h1",2),o(3," Il tuo carrello "),i(),h(4,z,10,0,"div",3)(5,W,17,7,"div",4),i(),r(6,"aside",5)(7,"h2",6),o(8,"Riepilogo ordine"),i(),r(9,"div",7)(10,"div",8)(11,"span"),o(12,"Subtotale"),i(),r(13,"span",9),o(14),c(15,"currency"),i()(),r(16,"div",8)(17,"span"),o(18,"IVA (22%)"),i(),r(19,"span",9),o(20),c(21,"currency"),i()(),r(22,"div",10)(23,"span"),o(24,"Totale"),i(),r(25,"span",11),o(26),c(27,"currency"),i()()(),r(28,"button",12),v("click",function(){return n.checkout()}),o(29," Procedi al pagamento \u2192 "),i(),h(30,$,1,3,"app-cart-paypal",13),r(31,"p",14),o(32," Pagamenti sicuri con carta, PayPal o bonifico bancario. "),i()()()),e&2&&(l(4),m("ngIf",n.isEmpty),l(),m("ngForOf",n.realCartItems),l(9),d(u(15,6,n.subtotal,"EUR")),l(6),d(u(21,9,n.subtotal*.22,"EUR")),l(6),d(u(27,12,n.subtotal*1.22,"EUR")),l(4),m("ngIf",n.user==null?null:n.user.id))},dependencies:[F,D,A,L,T,O,g,B],encapsulation:2})};export{N as CartComponent};

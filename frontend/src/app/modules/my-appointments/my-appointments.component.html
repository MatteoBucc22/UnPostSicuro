<div class="min-h-screen bg-gradient-to-b from-[#FAFAFA] via-white to-[#FAFAFA] py-20 px-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-[#2B3A67] mb-12">
      Le mie Prenotazioni
    </h1>

    <div class="flex justify-center mb-10">
      <button
        (click)="toggleBookingMode()"
        class="px-8 py-3 bg-[#5EADB1] text-white font-semibold rounded-xl hover:bg-[#4c9397] transition-all shadow-lg flex items-center gap-2"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
        </svg>
        {{ isBookingNew ? 'Annulla Nuova Prenotazione' : 'Prenota Nuova Seduta' }}
      </button>
    </div>

    <div *ngIf="isBookingNew" class="bg-white border border-gray-200 rounded-2xl shadow-xl p-8 mb-12">
      <h2 class="text-2xl font-bold text-[#2B3A67] mb-6">Nuova Prenotazione</h2>

      <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
        <span>üë©‚Äç‚öïÔ∏è</span> Seleziona uno specialista
      </h3>

      <div class="relative group mb-6">
        <button (click)="scrollLeft('new-booking')"
                class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white shadow-md p-2 rounded-full hidden group-hover:block transition">
          ‚Üê
        </button>

        <div
          class="flex gap-6 overflow-x-auto scroll-smooth pb-4 no-scrollbar transition-all duration-300"
          data-id="new-booking"
          (wheel)="onScroll($event)"
        >
          <div *ngFor="let s of specialists"
              (click)="selectedSpecialistId = s.id"
              [class.ring-4]="selectedSpecialistId === s.id"
              [class.ring-[#5EADB1]]="selectedSpecialistId === s.id"
              class="flex-shrink-0 w-72 cursor-pointer transition-transform duration-300 hover:scale-105 hover:shadow-lg rounded-2xl">
            <app-specialist-card [specialist]="s"></app-specialist-card>
          </div>
        </div>

        <button (click)="scrollRight('new-booking')"
                class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white shadow-md p-2 rounded-full hidden group-hover:block transition">
          ‚Üí
        </button>
      </div>

      <p *ngIf="selectedSpecialistId" class="text-green-600 mt-4 font-medium">
        ‚úÖ Specialista selezionato: **{{ getSpecialistNameById(selectedSpecialistId) }}**
      </p>
      
      <div *ngIf="selectedSpecialistId && user" class="mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
          <span>üìÖ</span> Seleziona data e orario
        </h3>
        <app-calendar
        [specialistId]="+selectedSpecialistId!"
          [userId]="user.id"
          (appointmentBooked)="onNewAppointmentBooked($event)"
          #newAppointmentCalendar>
        </app-calendar>
      </div>
      
      <button 
        *ngIf="selectedSpecialistId"
        (click)="isBookingNew = false; selectedSpecialistId = undefined"
        class="mt-6 px-6 py-2 rounded-full border border-gray-300 text-gray-700 font-medium bg-transparent hover:bg-gray-100 transition-all"
      >
        Annulla Selezione
      </button>

    </div>
    
    <div *ngIf="!isBookingNew">
      <div class="flex flex-col sm:flex-row gap-4 mb-6 justify-between items-center">
        <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="border rounded-full px-4 py-2">
          <option value="all">Tutti</option>
          <option value="booked">Confermato</option>
          <option value="completed">Completato</option>
          <option value="blocked">In attesa</option>
          <option value="canceled">Annullato</option>
        </select>

        <input
          type="date"
          [(ngModel)]="filterDate"
          (change)="applyFilters()"
          class="border rounded-full px-4 py-2"
        />
      </div>

      <div
        *ngFor="let app of filteredAppointments"
        class="bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 p-6 mb-8"
      >

        <div *ngIf="!app.editing" class="grid grid-cols-1 sm:grid-cols-3 items-center">
          
          <div class="text-left">
            <h2 class="text-xl font-semibold text-[#2B3A67]">
              {{ getSpecialistName(app) }}
            </h2>          
            <p class="text-gray-600 text-sm">
              {{ app.start_time | date: 'dd/MM/yyyy' }} ‚Ä¢ {{ app.start_time | date: 'HH:mm' }}
            </p>
          </div>

          <div class="flex justify-center my-4 sm:my-0">
            <div
              class="min-w-[120px] text-center px-4 py-1 rounded-full text-sm font-semibold"
              [ngClass]="{
                'bg-green-500 text-white': app.status === 'booked' || app.status === 'completed',
                'bg-yellow-500 text-white': app.status === 'blocked',
                'bg-red-500 text-white': app.status === 'canceled'
              }"
            >
              {{ translateStatus(app.status) }}
            </div>
          </div>

          <div class="flex justify-center sm:justify-end gap-3">
            <button
              *ngIf="app.status === 'booked'"
              (click)="app.editing = true"
              class="px-5 py-2 rounded-full bg-[#5EADB1] text-white font-semibold hover:brightness-110 transition-all"
            >
              Modifica
            </button>

            <button
              *ngIf="app.status !== 'canceled'"
              (click)="cancelAppointment(app.id)"
              class="px-5 py-2 rounded-full border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all"
            >
              Annulla
            </button>
          </div>
        </div>

        <div *ngIf="app.editing" class="border-t border-gray-100 pt-6 mt-4">
          <div class="text-left mb-4">
            <h2 class="text-xl font-semibold text-[#2B3A67]">
              {{ getSpecialistName(app) }}
            </h2>          
          </div>

          <input
            type="date"
            [(ngModel)]="app.newDate"
            (change)="onDateChange(app)"
            class="w-full border border-gray-300 rounded-full px-4 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#5EADB1]"
          />

          <div *ngIf="app.availableSlots?.length" class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-4">
            <button
              *ngFor="let slot of app.availableSlots"
              (click)="onSlotClick(app, slot)"
              [class.bg-[#5EADB1]]="app.newTime === slot"
              [class.text-white]="app.newTime === slot"
              [class.bg-gray-100]="app.newTime !== slot"
              [class.text-gray-700]="app.newTime !== slot"
              class="py-2 rounded-full text-sm font-medium transition-all hover:shadow-md"
            >
              {{ slot }}
            </button>
          </div>

          <p *ngIf="!app.availableSlots?.length && app.newDate" class="text-sm text-gray-500 mt-2">
            Nessuno slot disponibile per questa data.
          </p>

          <div class="flex justify-end gap-3 mt-5">
            <button
              (click)="updateAppointment(app)"
              class="px-6 py-2 rounded-full bg-gradient-to-r from-[#5EADB1] to-[#4F9FA4] text-white font-semibold shadow-md hover:shadow-lg hover:brightness-105 transition-all"
            >
              Salva
            </button>
            <button
              (click)="app.editing = false"
              class="px-6 py-2 rounded-full border border-gray-300 text-gray-700 font-medium bg-transparent hover:bg-gray-100 transition-all"
            >
              Annulla
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>